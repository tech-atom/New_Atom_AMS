<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="no-referrer">
    <title>My Progress - Online Exam</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='futuristic-theme.css') }}">
    <script src="{{ url_for('static', filename='chart.umd.js') }}"></script>
    <style>
        .progress-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .stat-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(0, 255, 255, 0.3);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.2);
        }
        
        .stat-value {
            font-size: 2.5em;
            font-weight: bold;
            color: #00ffff;
            margin: 10px 0;
        }
        
        .stat-label {
            font-size: 1em;
            color: rgba(255, 255, 255, 0.7);
        }
        
        .improvement-positive {
            color: #00ff88;
        }
        
        .improvement-negative {
            color: #ff4444;
        }
        
        .chart-container {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(0, 255, 255, 0.3);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.2);
        }
        
        .chart-title {
            font-size: 1.5em;
            color: #00ffff;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .subjects-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .subject-list {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(0, 255, 255, 0.3);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.2);
        }
        
        .subject-list h3 {
            color: #00ffff;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .subject-item {
            background: rgba(0, 0, 0, 0.3);
            border-left: 3px solid #00ffff;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
        }
        
        .subject-item.weak {
            border-left-color: #ff4444;
        }
        
        .subject-item.strong {
            border-left-color: #00ff88;
        }
        
        .subject-name {
            font-weight: bold;
            color: #fff;
        }
        
        .subject-percentage {
            color: #00ffff;
            float: right;
        }
        
        .recommendations {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(0, 255, 255, 0.3);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.2);
            margin-bottom: 30px;
        }
        
        .recommendations h3 {
            color: #00ffff;
            margin-bottom: 15px;
        }
        
        .recommendation-item {
            background: rgba(0, 0, 0, 0.3);
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 8px;
            border-left: 3px solid #00ff88;
        }
        
        .no-data {
            text-align: center;
            padding: 50px;
            color: rgba(255, 255, 255, 0.7);
            font-size: 1.2em;
        }
        
        .back-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            margin: 20px auto;
            display: block;
            text-decoration: none;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }
        
        .back-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.5);
        }
    </style>
</head>
<body>
    <div class="progress-container">
        <h1 style="text-align: center; color: #00ffff; margin-bottom: 30px; display: flex; align-items: center; justify-content: center; gap: 15px;">
            <svg width="40" height="40" fill="currentColor" viewBox="0 0 16 16">
                <path d="M4 11H2v3h2v-3zm5-4H7v7h2V7zm5-5v12h-2V2h2zm-2-1a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h2a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1h-2zM6 7a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v7a1 1 0 0 1-1 1H7a1 1 0 0 1-1-1V7zm-5 4a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1v-3z"/>
            </svg>
            {{ student_name }}'s Progress Report
        </h1>
        
        {% if student_course %}
        <p style="text-align: center; color: rgba(255,255,255,0.7); margin-bottom: 30px;">
            Course: {{ student_course }}
        </p>
        {% endif %}
        
        {% if total_exams > 0 %}
            <!-- Statistics Cards -->
            <div class="stat-cards">
                <div class="stat-card">
                    <div class="stat-label">Total Exams</div>
                    <div class="stat-value">{{ total_exams }}</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-label">Average Score</div>
                    <div class="stat-value">{{ average_score }}%</div>
                </div>
            </div>
            
            <!-- Score Trend Chart -->
            <div class="chart-container">
                <div class="chart-title" style="display: flex; align-items: center; justify-content: center; gap: 10px;">
                    <svg width="24" height="24" fill="currentColor" viewBox="0 0 16 16">
                        <path fill-rule="evenodd" d="M0 0h1v15h15v1H0V0zm10 3.5a.5.5 0 0 1 .5-.5h4a.5.5 0 0 1 .5.5v4a.5.5 0 0 1-1 0V4.9l-3.613 4.417a.5.5 0 0 1-.74.037L7.06 6.767l-3.656 5.027a.5.5 0 0 1-.808-.588l4-5.5a.5.5 0 0 1 .758-.06l2.609 2.61L13.445 4H10.5a.5.5 0 0 1-.5-.5z"/>
                    </svg>
                    Score Trend Over Time
                </div>
                <canvas id="scoreTrendChart"></canvas>
            </div>
            
            <!-- Subject Performance Chart -->
            <div class="chart-container">
                <div class="chart-title" style="display: flex; align-items: center; justify-content: center; gap: 10px;">
                    <svg width="24" height="24" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M1 2.828c.885-.37 2.154-.769 3.388-.893 1.33-.134 2.458.063 3.112.752v9.746c-.935-.53-2.12-.603-3.213-.493-1.18.12-2.37.461-3.287.811V2.828zm7.5-.141c.654-.689 1.782-.886 3.112-.752 1.234.124 2.503.523 3.388.893v9.923c-.918-.35-2.107-.692-3.287-.81-1.094-.111-2.278-.039-3.213.492V2.687zM8 1.783C7.015.936 5.587.81 4.287.94c-1.514.153-3.042.672-3.994 1.105A.5.5 0 0 0 0 2.5v11a.5.5 0 0 0 .707.455c.882-.4 2.303-.881 3.68-1.02 1.409-.142 2.59.087 3.223.877a.5.5 0 0 0 .78 0c.633-.79 1.814-1.019 3.222-.877 1.378.139 2.8.62 3.681 1.02A.5.5 0 0 0 16 13.5v-11a.5.5 0 0 0-.293-.455c-.952-.433-2.48-.952-3.994-1.105C10.413.809 8.985.936 8 1.783z"/>
                    </svg>
                    Subject-wise Performance
                </div>
                <canvas id="subjectPerformanceChart"></canvas>
            </div>
            
            <!-- Weak and Strong Subjects -->
            <div class="subjects-grid">
                <div class="subject-list">
                    <h3 style="display: flex; align-items: center; justify-content: center; gap: 10px;">
                        <svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm.93-9.412-1 4.705c-.07.34.029.533.304.533.194 0 .487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703 0-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381 2.29-.287zM8 5.5a1 1 0 1 1 0-2 1 1 0 0 1 0 2z"/>
                        </svg>
                        Areas for Improvement
                    </h3>
                    {% if weak_subjects %}
                        {% for subject in weak_subjects %}
                        <div class="subject-item weak">
                            <span class="subject-name">{{ subject.subject }}</span>
                            <span class="subject-percentage">{{ subject.percentage }}%</span>
                            <div style="clear: both; font-size: 0.9em; color: rgba(255,255,255,0.6);">
                                {{ subject.exams_taken }} exam(s) taken
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <p style="text-align: center; color: rgba(255,255,255,0.6);">No weak subjects identified</p>
                    {% endif %}
                </div>
                
                <div class="subject-list">
                    <h3 style="display: flex; align-items: center; justify-content: center; gap: 10px;">
                        <svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M3.612 15.443c-.386.198-.824-.149-.746-.592l.83-4.73L.173 6.765c-.329-.314-.158-.888.283-.95l4.898-.696L7.538.792c.197-.39.73-.39.927 0l2.184 4.327 4.898.696c.441.062.612.636.282.95l-3.522 3.356.83 4.73c.078.443-.36.79-.746.592L8 13.187l-4.389 2.256z"/>
                        </svg>
                        Strong Subjects
                    </h3>
                    {% if strong_subjects %}
                        {% for subject in strong_subjects %}
                        <div class="subject-item strong">
                            <span class="subject-name">{{ subject.subject }}</span>
                            <span class="subject-percentage">{{ subject.percentage }}%</span>
                            <div style="clear: both; font-size: 0.9em; color: rgba(255,255,255,0.6);">
                                {{ subject.exams_taken }} exam(s) taken
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <p style="text-align: center; color: rgba(255,255,255,0.6);">Take more exams to identify strengths</p>
                    {% endif %}
                </div>
            </div>
            
            <!-- Study Recommendations -->
            <div class="recommendations">
                <h3 style="display: flex; align-items: center; gap: 10px;">
                    <svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                        <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
                    </svg>
                    Personalized Study Recommendations
                </h3>
                {% for rec in recommendations %}
                <div class="recommendation-item">
                    {{ rec }}
                </div>
                {% endfor %}
            </div>
            
        {% else %}
            <div class="no-data">
                <svg width="60" height="60" fill="rgba(255, 255, 255, 0.3)" viewBox="0 0 16 16" style="margin-bottom: 15px;">
                    <path d="M5.5 7a.5.5 0 0 0 0 1h5a.5.5 0 0 0 0-1h-5zM5 9.5a.5.5 0 0 1 .5-.5h5a.5.5 0 0 1 0 1h-5a.5.5 0 0 1-.5-.5zm0 2a.5.5 0 0 1 .5-.5h2a.5.5 0 0 1 0 1h-2a.5.5 0 0 1-.5-.5z"/>
                    <path d="M9.5 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V4.5L9.5 0zm0 1v2A1.5 1.5 0 0 0 11 4.5h2V14a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h5.5z"/>
                </svg>
                <p>No exam data available yet</p>
                <p style="font-size: 0.9em; margin-top: 10px;">Take your first exam to start tracking your progress!</p>
            </div>
        {% endif %}
        
        <a href="{{ url_for('student_dashboard') }}" class="back-button" style="display: inline-block; text-decoration: none; position: relative; z-index: 1000;">‚Üê Back to Dashboard</a>
    </div>
    
    <script nonce="{{ csp_nonce() }}">
        console.log('Dashboard button loaded');
        
        // Debug button click
        document.addEventListener('DOMContentLoaded', function() {
            const backBtn = document.querySelector('.back-button');
            console.log('Back button found:', backBtn);
            if (backBtn) {
                backBtn.addEventListener('click', function(e) {
                    console.log('Button clicked!', e);
                });
            }
        });
        
        {% if total_exams > 0 %}
        // Prepare data for charts
        const examData = {{ exam_data | tojson }};
        
        // Score Trend Chart
        const scoreTrendCtx = document.getElementById('scoreTrendChart').getContext('2d');
        new Chart(scoreTrendCtx, {
            type: 'line',
            data: {
                labels: examData.map(e => e.date),
                datasets: [{
                    label: 'Score Percentage',
                    data: examData.map(e => e.percentage),
                    borderColor: '#00ffff',
                    backgroundColor: 'rgba(0, 255, 255, 0.1)',
                    borderWidth: 3,
                    tension: 0.4,
                    fill: true,
                    pointRadius: 5,
                    pointBackgroundColor: '#00ffff',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        labels: {
                            color: '#fff',
                            font: {
                                size: 14
                            }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            title: function(context) {
                                const index = context[0].dataIndex;
                                return examData[index].title;
                            },
                            label: function(context) {
                                const index = context.dataIndex;
                                return [
                                    `Score: ${examData[index].score}/${examData[index].total}`,
                                    `Percentage: ${context.parsed.y}%`,
                                    `Subject: ${examData[index].subject}`
                                ];
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        ticks: {
                            color: '#fff',
                            callback: function(value) {
                                return value + '%';
                            }
                        },
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)'
                        }
                    },
                    x: {
                        ticks: {
                            color: '#fff'
                        },
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)'
                        }
                    }
                }
            }
        });
        
        // Subject Performance Chart
        const subjectScores = {};
        examData.forEach(exam => {
            if (!subjectScores[exam.subject]) {
                subjectScores[exam.subject] = [];
            }
            subjectScores[exam.subject].push(exam.percentage);
        });
        
        const subjectLabels = Object.keys(subjectScores);
        const subjectAverages = subjectLabels.map(subject => {
            const scores = subjectScores[subject];
            return (scores.reduce((a, b) => a + b, 0) / scores.length).toFixed(2);
        });
        
        const subjectPerformanceCtx = document.getElementById('subjectPerformanceChart').getContext('2d');
        new Chart(subjectPerformanceCtx, {
            type: 'bar',
            data: {
                labels: subjectLabels,
                datasets: [{
                    label: 'Average Performance (%)',
                    data: subjectAverages,
                    backgroundColor: subjectAverages.map(score => {
                        if (score >= 80) return 'rgba(0, 255, 136, 0.6)';
                        if (score >= 60) return 'rgba(0, 255, 255, 0.6)';
                        if (score >= 40) return 'rgba(255, 196, 0, 0.6)';
                        return 'rgba(255, 68, 68, 0.6)';
                    }),
                    borderColor: subjectAverages.map(score => {
                        if (score >= 80) return '#00ff88';
                        if (score >= 60) return '#00ffff';
                        if (score >= 40) return '#ffc400';
                        return '#ff4444';
                    }),
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        labels: {
                            color: '#fff',
                            font: {
                                size: 14
                            }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `Average: ${context.parsed.y}%`;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        ticks: {
                            color: '#fff',
                            callback: function(value) {
                                return value + '%';
                            }
                        },
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)'
                        }
                    },
                    x: {
                        ticks: {
                            color: '#fff'
                        },
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)'
                        }
                    }
                }
            }
        });
        {% endif %}
    </script>
</body>
</html>
