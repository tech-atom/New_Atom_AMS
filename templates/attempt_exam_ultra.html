<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ exam[1] }} - ATOM SHAALE Exam</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            margin: 0;
            padding: 0;
            min-height: 100vh;
            background: linear-gradient(135deg, #0a0e27 0%, #1a1f3a 100%);
            color: #e0f2e9;
            position: relative;
            overflow-x: hidden;
        }
        
        /* PRODUCTION: Anti-Cheating Overlay */
        .security-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(239, 68, 68, 0.95);
            backdrop-filter: blur(20px);
            z-index: 99999;
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            color: white;
            text-align: center;
            padding: 40px;
        }
        
        .security-overlay.active {
            display: flex;
        }
        
        .security-icon {
            font-size: 80px;
            margin-bottom: 20px;
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.8; }
        }
        
        .security-message {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 15px;
        }
        
        .security-details {
            font-size: 18px;
            margin-bottom: 30px;
            opacity: 0.9;
        }
        
        .violation-timer {
            font-size: 48px;
            font-weight: 800;
            margin-bottom: 20px;
            color: #fbbf24;
        }
        
        /* PRODUCTION: Header with Timer and Status */
        .exam-fixed-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(16, 20, 35, 0.98);
            backdrop-filter: blur(20px);
            padding: 15px 30px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            z-index: 1000;
            border-bottom: 2px solid rgba(0, 128, 55, 0.4);
        }
        
        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 20px;
        }
        
        .exam-title-header {
            font-size: 20px;
            font-weight: 700;
            color: #00ff6a;
            flex: 1;
        }
        
        .timer-container {
            display: flex;
            align-items: center;
            gap: 15px;
            background: linear-gradient(135deg, rgba(0, 128, 55, 0.3), rgba(0, 128, 55, 0.2));
            padding: 12px 24px;
            border-radius: 12px;
            border: 2px solid rgba(0, 128, 55, 0.5);
        }
        
        .timer-icon {
            font-size: 24px;
            animation: tick 1s infinite;
        }
        
        @keyframes tick {
            0%, 50%, 100% { transform: scale(1); }
            25%, 75% { transform: scale(1.1); }
        }
        
        #examTimer {
            font-size: 28px;
            font-weight: 800;
            color: #00ff6a;
            font-family: 'Courier New', monospace;
            letter-spacing: 2px;
            min-width: 120px;
            text-align: center;
        }
        
        #examTimer.warning {
            color: #fbbf24;
            animation: timerWarning 1s infinite;
        }
        
        #examTimer.critical {
            color: #ef4444;
            animation: timerCritical 0.5s infinite;
        }
        
        @keyframes timerWarning {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        @keyframes timerCritical {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .status-indicators {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        .status-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            background: rgba(26, 32, 53, 0.6);
            border: 1px solid rgba(0, 128, 55, 0.3);
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #00ff6a;
            animation: pulse 2s infinite;
        }
        
        /* PRODUCTION: Main Content */
        .container {
            max-width: 1200px;
            margin: 100px auto 40px;
            padding: 0 20px;
        }
        
        .exam-info-card {
            background: rgba(16, 20, 35, 0.8);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            border: 2px solid rgba(0, 128, 55, 0.4);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .info-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 15px;
            background: rgba(0, 128, 55, 0.15);
            border-radius: 12px;
            border: 1px solid rgba(0, 128, 55, 0.3);
        }
        
        .info-icon {
            font-size: 24px;
        }
        
        .info-label {
            font-size: 13px;
            color: #b8e6d5;
            opacity: 0.8;
        }
        
        .info-value {
            font-size: 18px;
            font-weight: 700;
            color: #00ff6a;
        }
        
        /* PRODUCTION: Question Card */
        .question-card {
            background: rgba(16, 20, 35, 0.8);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 35px;
            margin-bottom: 25px;
            border: 2px solid rgba(0, 128, 55, 0.3);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.5);
            transition: all 0.3s ease;
        }
        
        .question-card:hover {
            border-color: rgba(0, 128, 55, 0.6);
            box-shadow: 0 12px 40px rgba(0, 128, 55, 0.2);
        }
        
        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(0, 128, 55, 0.2);
        }
        
        .question-number {
            background: linear-gradient(135deg, #008037, #00ff6a);
            color: #000;
            padding: 8px 16px;
            border-radius: 10px;
            font-weight: 800;
            font-size: 16px;
        }
        
        .question-type-badge {
            background: rgba(245, 158, 11, 0.2);
            color: #fbbf24;
            padding: 6px 14px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            border: 1px solid rgba(245, 158, 11, 0.4);
        }
        
        .question-text {
            font-size: 19px;
            font-weight: 600;
            color: #e0f2e9;
            line-height: 1.7;
            margin: 20px 0;
        }
        
        .question-image {
            max-width: 100%;
            height: auto;
            border-radius: 12px;
            margin: 20px 0;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            border: 2px solid rgba(0, 128, 55, 0.3);
        }
        
        /* PRODUCTION: Options */
        .options-container {
            margin-top: 25px;
        }
        
        .option {
            margin: 12px 0;
        }
        
        .option-label {
            display: flex;
            align-items: center;
            padding: 18px 24px;
            background: rgba(26, 32, 53, 0.6);
            border: 2px solid rgba(0, 128, 55, 0.25);
            border-radius: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .option-label::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 0;
            height: 100%;
            background: linear-gradient(135deg, rgba(0, 128, 55, 0.15), rgba(0, 255, 106, 0.08));
            transition: width 0.4s ease;
            z-index: 0;
        }
        
        .option-label:hover {
            border-color: #008037;
            transform: translateX(4px);
            box-shadow: 0 6px 20px rgba(0, 128, 55, 0.3);
        }
        
        .option-label:hover::before {
            width: 100%;
        }
        
        .option input[type="radio"] {
            width: 22px;
            height: 22px;
            margin-right: 15px;
            cursor: pointer;
            accent-color: #008037;
            position: relative;
            z-index: 1;
        }
        
        .option input[type="radio"]:checked ~ * {
            color: #00ff6a;
        }
        
        .option-letter {
            font-weight: 800;
            margin-right: 12px;
            font-size: 18px;
            position: relative;
            z-index: 1;
        }
        
        .option-text {
            flex: 1;
            font-size: 16px;
            font-weight: 500;
            position: relative;
            z-index: 1;
        }
        
        /* PRODUCTION: Textarea */
        .answer-textarea {
            width: 100%;
            min-height: 150px;
            padding: 18px;
            background: rgba(26, 32, 53, 0.6);
            border: 2px solid rgba(0, 128, 55, 0.3);
            border-radius: 14px;
            color: #e0f2e9;
            font-size: 16px;
            font-family: 'Inter', sans-serif;
            line-height: 1.6;
            resize: vertical;
            transition: all 0.3s ease;
        }
        
        .answer-textarea:focus {
            outline: none;
            border-color: #008037;
            box-shadow: 0 0 20px rgba(0, 128, 55, 0.3);
        }
        
        .answer-textarea::placeholder {
            color: #6b8899;
        }
        
        /* PRODUCTION: Buttons */
        .action-buttons {
            position: sticky;
            bottom: 20px;
            text-align: center;
            margin: 40px 0;
            z-index: 100;
        }
        
        .btn-submit {
            padding: 20px 50px;
            background: linear-gradient(135deg, #008037 0%, #00ff6a 100%);
            color: #000;
            border: none;
            border-radius: 16px;
            font-size: 20px;
            font-weight: 800;
            cursor: pointer;
            box-shadow: 0 10px 30px rgba(0, 128, 55, 0.5), 0 0 40px rgba(0, 255, 106, 0.3);
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 12px;
            position: relative;
            overflow: hidden;
        }
        
        .btn-submit::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s;
        }
        
        .btn-submit:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 40px rgba(0, 128, 55, 0.7), 0 0 60px rgba(0, 255, 106, 0.5);
        }
        
        .btn-submit:hover::before {
            left: 100%;
        }
        
        .btn-submit:active {
            transform: translateY(-1px);
        }
        
        .btn-submit:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        /* PRODUCTION: Auto-save indicator */
        .autosave-indicator {
            position: fixed;
            bottom: 30px;
            left: 30px;
            background: rgba(16, 20, 35, 0.95);
            backdrop-filter: blur(20px);
            padding: 12px 20px;
            border-radius: 12px;
            border: 2px solid rgba(0, 128, 55, 0.4);
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
            font-weight: 600;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .autosave-indicator.show {
            opacity: 1;
        }
        
        .autosave-spinner {
            width: 16px;
            height: 16px;
            border: 3px solid rgba(0, 255, 106, 0.3);
            border-top-color: #00ff6a;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* PRODUCTION: Proctoring Webcam */
        .proctor-container {
            position: fixed;
            top: 100px;
            right: 30px;
            z-index: 1000;
            background: rgba(16, 20, 35, 0.95);
            backdrop-filter: blur(20px);
            padding: 15px;
            border-radius: 16px;
            border: 2px solid rgba(0, 128, 55, 0.4);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.6);
        }
        
        #webcam {
            width: 200px;
            height: 150px;
            border-radius: 10px;
            border: 2px solid #008037;
            object-fit: cover;
        }
        
        .proctor-status {
            margin-top: 10px;
            font-size: 12px;
            color: #00ff6a;
            text-align: center;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        
        /* PRODUCTION: Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(10, 14, 39, 0.98);
            backdrop-filter: blur(20px);
            z-index: 10000;
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        
        .loading-overlay.active {
            display: flex;
        }
        
        .loading-spinner {
            width: 80px;
            height: 80px;
            border: 6px solid rgba(0, 255, 106, 0.2);
            border-top-color: #00ff6a;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        .loading-text {
            font-size: 20px;
            font-weight: 600;
            color: #00ff6a;
        }
        
        /* PRODUCTION: Responsive Design */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 15px;
            }
            
            .exam-title-header {
                font-size: 16px;
            }
            
            #examTimer {
                font-size: 24px;
            }
            
            .proctor-container {
                top: auto;
                bottom: 20px;
                right: 20px;
            }
            
            #webcam {
                width: 150px;
                height: 112px;
            }
            
            .container {
                margin-top: 160px;
            }
            
            .question-card {
                padding: 20px;
            }
            
            .btn-submit {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <!-- PRODUCTION: Security Violation Overlay -->
    <div class="security-overlay" id="securityOverlay">
        <div class="security-icon">‚ö†Ô∏è</div>
        <div class="security-message">Exam Violation Detected!</div>
        <div class="security-details" id="violationMessage">You switched tabs/windows during the exam</div>
        <div class="violation-timer" id="violationTimer">10</div>
        <div class="security-details">Exam will auto-submit in <span id="autoSubmitTime">10</span> seconds</div>
    </div>

    <!-- PRODUCTION: Fixed Header with Timer -->
    <div class="exam-fixed-header">
        <div class="header-content">
            <div class="exam-title-header">üìù {{ exam[1] }}</div>
            <div class="timer-container">
                <div class="timer-icon">‚è±Ô∏è</div>
                <div id="examTimer">{{ exam[3] }}:00</div>
            </div>
            <div class="status-indicators">
                <div class="status-badge">
                    <div class="status-dot"></div>
                    <span>Active</span>
                </div>
            </div>
        </div>
    </div>

    <!-- PRODUCTION: AI Proctoring -->
    <div class="proctor-container" id="proctorContainer">
        <video id="webcam" autoplay muted></video>
        <div class="proctor-status">
            <div class="status-dot"></div>
            <span>Monitoring Active</span>
        </div>
    </div>

    <!-- PRODUCTION: Auto-save Indicator -->
    <div class="autosave-indicator" id="autosaveIndicator">
        <div class="autosave-spinner"></div>
        <span>Auto-saving...</span>
    </div>

    <!-- PRODUCTION: Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">Submitting your exam...</div>
    </div>

    <!-- Main Content -->
    <div class="container">
        <!-- Exam Info Card -->
        <div class="exam-info-card">
            <h2 style="color: #00ff6a; margin-bottom: 20px;">üìö {{ exam[2] }}</h2>
            <div class="info-grid">
                <div class="info-item">
                    <div class="info-icon">üìä</div>
                    <div>
                        <div class="info-label">Total Questions</div>
                        <div class="info-value">{{ questions|length }}</div>
                    </div>
                </div>
                <div class="info-item">
                    <div class="info-icon">‚è∞</div>
                    <div>
                        <div class="info-label">Time Limit</div>
                        <div class="info-value">{{ exam[3] }} min</div>
                    </div>
                </div>
                <div class="info-item">
                    <div class="info-icon">üîí</div>
                    <div>
                        <div class="info-label">Security</div>
                        <div class="info-value">Enabled</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Exam Form -->
        <form id="examForm" method="POST" action="/student/exam/{{ exam[0] }}/submit">
            {% for question in questions %}
            <div class="question-card" data-question-id="{{ question[0] }}">
                <div class="question-header">
                    <div class="question-number">Question {{ loop.index }}</div>
                    <div class="question-type-badge">
                        {% if question[3] == 'mcq' %}MCQ
                        {% elif question[3] == 'true_false' %}True/False
                        {% elif question[3] == 'descriptive' %}Descriptive
                        {% elif question[3] == 'image_mcq' %}Image MCQ
                        {% elif question[3] == 'video_response' %}Video Response
                        {% else %}Question{% endif %}
                    </div>
                </div>

                <div class="question-text">{{ question[2] }}</div>

                {% if question[10] %}
                <img src="/static/question_images/{{ question[10] }}" alt="Question Image" class="question-image">
                {% endif %}

                {% if question[3] == 'descriptive' %}
                <div style="margin-top: 20px;">
                    <textarea name="answer_{{ question[0] }}" 
                              class="answer-textarea" 
                              placeholder="Type your detailed answer here..."
                              required
                              data-autosave="true"></textarea>
                </div>

                {% elif question[3] == 'true_false' %}
                <div class="options-container">
                    <div class="option">
                        <label class="option-label">
                            <input type="radio" name="answer_{{ question[0] }}" value="True" required data-autosave="true">
                            <span class="option-letter">‚úì</span>
                            <span class="option-text">True</span>
                        </label>
                    </div>
                    <div class="option">
                        <label class="option-label">
                            <input type="radio" name="answer_{{ question[0] }}" value="False" data-autosave="true">
                            <span class="option-letter">‚úó</span>
                            <span class="option-text">False</span>
                        </label>
                    </div>
                </div>

                {% else %}
                <div class="options-container">
                    <div class="option">
                        <label class="option-label">
                            <input type="radio" name="answer_{{ question[0] }}" value="A" required data-autosave="true">
                            <span class="option-letter">A)</span>
                            <span class="option-text">{{ question[4] }}</span>
                        </label>
                    </div>
                    <div class="option">
                        <label class="option-label">
                            <input type="radio" name="answer_{{ question[0] }}" value="B" data-autosave="true">
                            <span class="option-letter">B)</span>
                            <span class="option-text">{{ question[5] }}</span>
                        </label>
                    </div>
                    {% if question[6] %}
                    <div class="option">
                        <label class="option-label">
                            <input type="radio" name="answer_{{ question[0] }}" value="C" data-autosave="true">
                            <span class="option-letter">C)</span>
                            <span class="option-text">{{ question[6] }}</span>
                        </label>
                    </div>
                    {% endif %}
                    {% if question[7] %}
                    <div class="option">
                        <label class="option-label">
                            <input type="radio" name="answer_{{ question[0] }}" value="D" data-autosave="true">
                            <span class="option-letter">D)</span>
                            <span class="option-text">{{ question[7] }}</span>
                        </label>
                    </div>
                    {% endif %}
                </div>
                {% endif %}
            </div>
            {% endfor %}

            <!-- Submit Button -->
            <div class="action-buttons">
                <button type="button" id="submitBtn" class="btn-submit">
                    <svg width="24" height="24" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M10.97 4.97a.75.75 0 0 1 1.07 1.05l-3.99 4.99a.75.75 0 0 1-1.08.02L4.324 8.384a.75.75 0 1 1 1.06-1.06l2.094 2.093 3.473-4.425a.267.267 0 0 1 .02-.022z"/>
                    </svg>
                    <span id="submitBtnText">Submit Exam</span>
                </button>
            </div>
        </form>
    </div>

    <script>
        // ========== PRODUCTION: GLOBAL CONFIGURATION ==========
        const EXAM_CONFIG = {
            examId: {{ exam[0] }},
            timeLimit: {{ exam[3] }},  // minutes
            warningThreshold: 5,        // minutes remaining for warning
            criticalThreshold: 2,       // minutes remaining for critical
            maxViolations: 3,           // max tab switches before auto-submit
            autoSaveInterval: 30000,    // auto-save every 30 seconds
            violationGracePeriod: 10,   // seconds before auto-submit after violation
            setupGracePeriod: 5000      // 5 seconds grace period for camera/fullscreen setup
        };

        let examState = {
            timeRemaining: EXAM_CONFIG.timeLimit * 60,  // in seconds
            violations: 0,
            isSubmitting: false,
            autoSaveTimer: null,
            countdownTimer: null,
            violationTimeout: null,
            examStarted: false,         // NEW: Track if exam has fully started
            isSettingUp: true,          // NEW: Track if still in setup phase
            cameraReady: false,         // NEW: Track if camera is initialized
            setupStartTime: Date.now()  // NEW: Track when setup began
        };

        // ========== PRODUCTION: EXAM TIMER ==========
        function startExamTimer() {
            const timerDisplay = document.getElementById('examTimer');
            
            examState.countdownTimer = setInterval(() => {
                examState.timeRemaining--;
                
                const minutes = Math.floor(examState.timeRemaining / 60);
                const seconds = examState.timeRemaining % 60;
                const timeString = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                
                timerDisplay.textContent = timeString;
                
                // Update timer color based on remaining time
                const minutesRemaining = examState.timeRemaining / 60;
                timerDisplay.classList.remove('warning', 'critical');
                
                if (minutesRemaining <= EXAM_CONFIG.criticalThreshold) {
                    timerDisplay.classList.add('critical');
                } else if (minutesRemaining <= EXAM_CONFIG.warningThreshold) {
                    timerDisplay.classList.add('warning');
                }
                
                // Auto-submit when time expires
                if (examState.timeRemaining <= 0) {
                    clearInterval(examState.countdownTimer);
                    alert('Time is up! Your exam will be submitted automatically.');
                    submitExam(true);
                }
            }, 1000);
        }

        // ========== PRODUCTION: ANTI-CHEATING FEATURES ==========
        
        // Disable right-click
        document.addEventListener('contextmenu', (e) => {
            e.preventDefault();
            showTemporaryMessage('Right-click is disabled during the exam', 'warning');
        });

        // Disable copy-paste
        document.addEventListener('copy', (e) => {
            e.preventDefault();
            showTemporaryMessage('Copy is disabled during the exam', 'warning');
        });

        document.addEventListener('paste', (e) => {
            e.preventDefault();
            showTemporaryMessage('Paste is disabled during the exam', 'warning');
        });

        // Disable text selection
        document.addEventListener('selectstart', (e) => {
            if (!e.target.classList.contains('answer-textarea')) {
                e.preventDefault();
            }
        });

        // Detect tab/window switching
        let hiddenTime = 0;
        
        document.addEventListener('visibilitychange', () => {
            // ‚úÖ FIX: Only detect violations after exam has fully started
            if (!examState.examStarted || examState.isSubmitting || examState.isSettingUp) {
                console.log('[SECURITY] Ignoring visibility change during setup');
                return;
            }
            
            if (document.hidden) {
                hiddenTime = Date.now();
            } else {
                if (hiddenTime > 0) {
                    // Check if setup grace period has passed
                    const timeSinceSetup = Date.now() - examState.setupStartTime;
                    if (timeSinceSetup > EXAM_CONFIG.setupGracePeriod) {
                        handleTabSwitch();
                    } else {
                        console.log('[SECURITY] Ignoring tab switch during setup grace period');
                    }
                    hiddenTime = 0;
                }
            }
        });

        window.addEventListener('blur', () => {
            // ‚úÖ FIX: Only detect blur after exam has fully started
            if (examState.examStarted && !examState.isSubmitting && !examState.isSettingUp && !document.hidden) {
                console.warn('[SECURITY] Window blur detected');
            }
        });

        function handleTabSwitch() {
            // ‚úÖ FIX: Double-check we should be monitoring violations
            if (!examState.examStarted || examState.isSubmitting || examState.isSettingUp) {
                console.log('[SECURITY] Ignoring violation during setup/submission');
                return;
            }
            
            // Check if we're still in grace period
            const timeSinceSetup = Date.now() - examState.setupStartTime;
            if (timeSinceSetup < EXAM_CONFIG.setupGracePeriod) {
                console.log('[SECURITY] Ignoring violation - still in grace period');
                return;
            }
            
            examState.violations++;
            console.error(`[SECURITY] ‚ö†Ô∏è Tab switch violation #${examState.violations}`);
            
            const overlay = document.getElementById('securityOverlay');
            const violationMsg = document.getElementById('violationMessage');
            const violationTimer = document.getElementById('violationTimer');
            const autoSubmitTime = document.getElementById('autoSubmitTime');
            
            if (examState.violations >= EXAM_CONFIG.maxViolations) {
                // Max violations - auto-submit
                violationMsg.textContent = `Maximum violations reached (${EXAM_CONFIG.maxViolations}/${EXAM_CONFIG.maxViolations})`;
                overlay.classList.add('active');
                
                let countdown = EXAM_CONFIG.violationGracePeriod;
                violationTimer.textContent = countdown;
                autoSubmitTime.textContent = countdown;
                
                clearInterval(examState.violationTimeout);
                examState.violationTimeout = setInterval(() => {
                    countdown--;
                    violationTimer.textContent = countdown;
                    autoSubmitTime.textContent = countdown;
                    
                    if (countdown <= 0) {
                        clearInterval(examState.violationTimeout);
                        submitExam(true);
                    }
                }, 1000);
            } else {
                // Warning only
                alert(`‚ö†Ô∏è WARNING: Tab/window switch detected!\n\nViolation ${examState.violations}/${EXAM_CONFIG.maxViolations}\n\nAfter ${EXAM_CONFIG.maxViolations} violations, your exam will be auto-submitted.`);
            }
        }

        // Disable keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            // Disable F12 (DevTools)
            if (e.key === 'F12') {
                e.preventDefault();
                return false;
            }
            
            // Disable Ctrl+Shift+I (DevTools)
            if (e.ctrlKey && e.shiftKey && e.key === 'I') {
                e.preventDefault();
                return false;
            }
            
            // Disable Ctrl+U (View Source)
            if (e.ctrlKey && e.key === 'u') {
                e.preventDefault();
                return false;
            }
            
            // Disable Ctrl+S (Save Page)
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                return false;
            }
            
            // Disable Print Screen
            if (e.key === 'PrintScreen') {
                e.preventDefault();
                showTemporaryMessage('Screenshots are disabled during the exam', 'warning');
                return false;
            }
        });

        // ========== PRODUCTION: AUTO-SAVE FUNCTIONALITY ==========
        function autoSaveAnswers() {
            const indicator = document.getElementById('autosaveIndicator');
            indicator.classList.add('show');
            
            // Get all answers
            const formData = new FormData(document.getElementById('examForm'));
            const answers = {};
            
            for (let [key, value] of formData.entries()) {
                if (key.startsWith('answer_')) {
                    answers[key] = value;
                }
            }
            
            // Store in localStorage
            localStorage.setItem(`exam_${EXAM_CONFIG.examId}_answers`, JSON.stringify(answers));
            localStorage.setItem(`exam_${EXAM_CONFIG.examId}_timestamp`, Date.now());
            
            console.log('[AUTO-SAVE] Answers saved:', Object.keys(answers).length);
            
            setTimeout(() => {
                indicator.classList.remove('show');
            }, 2000);
        }

        // Restore saved answers on page load
        function restoreSavedAnswers() {
            const savedAnswers = localStorage.getItem(`exam_${EXAM_CONFIG.examId}_answers`);
            const timestamp = localStorage.getItem(`exam_${EXAM_CONFIG.examId}_timestamp`);
            
            if (savedAnswers && timestamp) {
                const timeDiff = Date.now() - parseInt(timestamp);
                // Only restore if saved within last hour
                if (timeDiff < 3600000) {
                    const answers = JSON.parse(savedAnswers);
                    
                    for (let [key, value] of Object.entries(answers)) {
                        const input = document.querySelector(`[name="${key}"][value="${value}"]`);
                        if (input) {
                            if (input.type === 'radio') {
                                input.checked = true;
                            } else {
                                input.value = value;
                            }
                        }
                    }
                    
                    console.log('[AUTO-SAVE] Restored answers:', Object.keys(answers).length);
                    showTemporaryMessage('Previous answers restored', 'success');
                }
            }
        }

        // Setup auto-save on input changes
        function setupAutoSave() {
            const inputs = document.querySelectorAll('[data-autosave="true"]');
            
            inputs.forEach(input => {
                input.addEventListener('change', () => {
                    clearTimeout(examState.autoSaveTimer);
                    examState.autoSaveTimer = setTimeout(autoSaveAnswers, 1000);
                });
            });
            
            // Also auto-save periodically
            setInterval(autoSaveAnswers, EXAM_CONFIG.autoSaveInterval);
        }

        // ========== PRODUCTION: EXAM SUBMISSION ==========
        function submitExam(isAutoSubmit = false) {
            if (examState.isSubmitting) {
                return;
            }
            
            if (!isAutoSubmit) {
                const confirmation = confirm('Are you sure you want to submit your exam?\n\nYou cannot change your answers after submission.');
                if (!confirmation) {
                    return;
                }
            }
            
            examState.isSubmitting = true;
            
            // Clear timers
            clearInterval(examState.countdownTimer);
            clearInterval(examState.violationTimeout);
            
            // Show loading
            document.getElementById('loadingOverlay').classList.add('active');
            document.getElementById('submitBtn').disabled = true;
            
            // Clear saved answers
            localStorage.removeItem(`exam_${EXAM_CONFIG.examId}_answers`);
            localStorage.removeItem(`exam_${EXAM_CONFIG.examId}_timestamp`);
            
            console.log('[PRODUCTION] Submitting exam...');
            
            // Submit form
            setTimeout(() => {
                document.getElementById('examForm').submit();
            }, 500);
        }

        // ========== PRODUCTION: AI PROCTORING ==========
        async function startProctoring() {
            try {
                console.log('[PROCTORING] Requesting camera access...');
                
                // ‚úÖ FIX: Request camera FIRST, before any fullscreen
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: true,
                    audio: false
                });
                
                const webcam = document.getElementById('webcam');
                webcam.srcObject = stream;
                
                // ‚úÖ Mark camera as ready
                examState.cameraReady = true;
                console.log('[PROCTORING] ‚úÖ Webcam started successfully');
                
                return true;
            } catch (err) {
                console.error('[PROCTORING] ‚ùå Webcam error:', err);
                const proctorContainer = document.getElementById('proctorContainer');
                proctorContainer.innerHTML = '<div style="padding: 20px; text-align: center; color: #ef4444;">‚ö†Ô∏è Camera access denied</div>';
                
                // Camera optional - allow exam to continue
                examState.cameraReady = false;
                return false;
            }
        }
        
        // ========== PRODUCTION: COMPLETE EXAM INITIALIZATION ==========
        async function completeExamSetup() {
            console.log('[PRODUCTION] üöÄ Starting complete exam setup sequence...');
            
            try {
                // ‚úÖ STEP 1: Request camera permissions FIRST (before fullscreen)
                console.log('[SETUP] Step 1: Requesting camera...');
                await startProctoring();
                
                // ‚úÖ Wait a moment for camera stream to stabilize
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // ‚úÖ STEP 2: Start exam timer
                console.log('[SETUP] Step 2: Starting timer...');
                startExamTimer();
                
                // ‚úÖ STEP 3: Setup auto-save
                console.log('[SETUP] Step 3: Setting up auto-save...');
                setupAutoSave();
                
                // ‚úÖ STEP 4: Restore saved answers
                console.log('[SETUP] Step 4: Restoring saved answers...');
                restoreSavedAnswers();
                
                // ‚úÖ STEP 5: Setup submit button
                console.log('[SETUP] Step 5: Setting up submit button...');
                document.getElementById('submitBtn').addEventListener('click', () => {
                    submitExam(false);
                });
                
                // ‚úÖ STEP 6: Setup page protection
                console.log('[SETUP] Step 6: Setting up page protection...');
                window.addEventListener('beforeunload', (e) => {
                    if (!examState.isSubmitting) {
                        e.preventDefault();
                        e.returnValue = 'Are you sure you want to leave? Your exam progress will be lost.';
                        return e.returnValue;
                    }
                });
                
                // Prevent accidental browser back
                history.pushState(null, null, location.href);
                window.addEventListener('popstate', () => {
                    if (!examState.isSubmitting) {
                        history.pushState(null, null, location.href);
                        alert('Please use the Submit button to exit the exam.');
                    }
                });
                
                // ‚úÖ STEP 7: Wait for grace period to complete
                const setupDuration = Date.now() - examState.setupStartTime;
                const remainingGracePeriod = Math.max(0, EXAM_CONFIG.setupGracePeriod - setupDuration);
                
                if (remainingGracePeriod > 0) {
                    console.log(`[SETUP] Waiting ${remainingGracePeriod}ms more for grace period...`);
                    await new Promise(resolve => setTimeout(resolve, remainingGracePeriod));
                }
                
                // ‚úÖ STEP 8: Mark exam as fully started (LAST STEP!)
                examState.isSettingUp = false;
                examState.examStarted = true;
                
                console.log('[PRODUCTION] ‚úÖ Exam system initialized successfully!');
                console.log('[PRODUCTION] üîí Security monitoring NOW ACTIVE');
                showTemporaryMessage('Exam started - Good luck!', 'success');
                
            } catch (error) {
                console.error('[PRODUCTION] ‚ùå Setup error:', error);
                examState.isSettingUp = false;
                examState.examStarted = true; // Start anyway, security will work
                showTemporaryMessage('Setup complete with warnings', 'warning');
            }
        }

        // ========== UTILITY FUNCTIONS ==========
        function showTemporaryMessage(message, type = 'info') {
            const colors = {
                info: '#3b82f6',
                success: '#00ff6a',
                warning: '#fbbf24',
                error: '#ef4444'
            };
            
            const messageDiv = document.createElement('div');
            messageDiv.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: rgba(16, 20, 35, 0.98);
                color: ${colors[type]};
                padding: 15px 30px;
                border-radius: 12px;
                border: 2px solid ${colors[type]};
                z-index: 10000;
                font-weight: 600;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
                animation: slideDown 0.3s ease;
            `;
            messageDiv.textContent = message;
            document.body.appendChild(messageDiv);
            
            setTimeout(() => {
                messageDiv.style.animation = 'slideUp 0.3s ease';
                setTimeout(() => messageDiv.remove(), 300);
            }, 3000);
        }

        // ========== INITIALIZATION ==========
        document.addEventListener('DOMContentLoaded', () => {
            console.log('[PRODUCTION] üéØ DOM loaded, starting initialization...');
            
            // ‚úÖ FIX: Use proper async initialization sequence
            completeExamSetup();
        });

        // Add slide animations to CSS
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideDown {
                from { transform: translate(-50%, -100px); opacity: 0; }
                to { transform: translate(-50%, 0); opacity: 1; }
            }
            @keyframes slideUp {
                from { transform: translate(-50%, 0); opacity: 1; }
                to { transform: translate(-50%, -100px); opacity: 0; }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>
